<div class="project-status-container">
    <p-toast></p-toast>

    <!-- Header -->
    <div class="header-section">
        <div>
            <h1 class="page-title">
                <i class="pi pi-list"></i> Project Status
            </h1>
            <p class="page-subtitle">Monitor project status and progress</p>
        </div>
        <p-button 
            label="Generate Report"
            icon="pi pi-refresh"
            [loading]="generatingReport"
            [disabled]="generatingReport"
            (onClick)="generateReport()">
        </p-button>
    </div>

    <!-- General Notes Section -->
    <p-card styleClass="mb-4">
        <div class="general-notes-section">
            <div class="notes-header">
                <h3><i class="pi pi-file-edit"></i> General Notes</h3>
                <div class="notes-actions">
                    @if (!isEditingGeneralNotes) {
                    <p-button 
                        label="Edit"
                        icon="pi pi-pencil"
                        [text]="true"
                        size="small"
                        (onClick)="toggleEditGeneralNotes()">
                    </p-button>
                    }
                    @if (isEditingGeneralNotes) {
                    <div style="display: flex; gap: 0.5rem;">
                        <p-button 
                            label="Cancel"
                            icon="pi pi-times"
                            [text]="true"
                            size="small"
                            severity="secondary"
                            (onClick)="cancelEditGeneralNotes()">
                        </p-button>
                        <p-button 
                            label="Save"
                            icon="pi pi-check"
                            size="small"
                            [loading]="savingGeneralNotes"
                            (onClick)="saveGeneralNotes()">
                        </p-button>
                    </div>
                    }
                </div>
            </div>
            @if (!isEditingGeneralNotes) {
            <div class="notes-content">
                @if (!generalNotes) {
                <p style="color: var(--text-color-secondary); font-style: italic;">
                    No general notes yet. Click Edit to add notes.
                </p>
                }
                @if (generalNotes) {
                <div class="preview-content" [innerHTML]="getSafeGeneralNotes()"></div>
                }
            </div>
            }
            @if (isEditingGeneralNotes) {
            <p-editor
                [(ngModel)]="generalNotes"
                [style]="{'height':'200px', 'width': '100%'}"
                placeholder="Enter general notes about the project status...">
                <ng-template pTemplate="header">
                    <span class="ql-formats">
                        <select class="ql-header">
                            <option value="1">Heading 1</option>
                            <option value="2">Heading 2</option>
                            <option value="3">Heading 3</option>
                            <option selected>Normal</option>
                        </select>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-bold" type="button"></button>
                        <button class="ql-italic" type="button"></button>
                        <button class="ql-underline" type="button"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-list" value="ordered" type="button"></button>
                        <button class="ql-list" value="bullet" type="button"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-link" type="button"></button>
                        <button class="ql-code-block" type="button"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-clean" type="button"></button>
                    </span>
                </ng-template>
            </p-editor>
            }
        </div>
    </p-card>

    <!-- Projects Status Cards -->
    @if (loading) {
    <div class="loading-state">
        <i class="pi pi-spin pi-spinner" style="font-size: 3rem;"></i>
        <p>Loading projects...</p>
    </div>
    }

    @if (!loading && projectStatuses.length > 0) {
    <p-accordion [multiple]="true" styleClass="project-accordion">
      
        @for (project of projectStatuses; track project.projectId) {
        <p-accordionpanel>
            <p-accordionheader>
                <div class="accordion-header-content">
                    <div class="header-left">
                        <strong>{{ project.projectName }}</strong>
                        <div class="header-tags">
                            @if (project.reworkPercentage > 0) {
                            <p-tag 
                                [value]="'Rework: ' + project.reworkPercentage.toFixed(1) + '%'"
                                [attr.severity]="project.reworkPercentage > 20 ? 'danger' : 'warning'">
                            </p-tag>
                            }
                            @if (project.userStoryStats && project.userStoryStats.total > 0) {
                            <p-button 
                                [label]="project.showReworkChart ? 'Refresh' : 'Load Chart'"
                                [icon]="project.showReworkChart ? 'pi pi-refresh' : 'pi pi-chart-bar'"
                                size="small"
                                [text]="true"
                                [loading]="project.loadingReworkChart"
                                (onClick)="loadReworkChartData(project); $event.stopPropagation()">
                            </p-button>
                            }
                        </div>
                    </div>
                </div>
            </p-accordionheader>
            <p-accordioncontent>

            <!-- Area Path Filters (Top Priority) -->
            @if (project.areaPaths && project.areaPaths.length > 0) {
            <p-card styleClass="filter-card">
                <div class="filter-header">
                    <div class="filter-title">
                        <i class="pi pi-filter"></i>
                        <h4>Filter by Area Path</h4>
                        @if (project.selectedAreaPaths && project.selectedAreaPaths.length > 0) {
                        <p-tag 
                            [value]="project.selectedAreaPaths.length + ' selected'"
                            severity="info"
                            [style]="{'font-size': '0.75rem'}">
                        </p-tag>
                        }
                    </div>
                    <div class="filter-actions">
                        @if (project.loadingAreaPathChange) {
                        <i class="pi pi-spin pi-spinner" style="font-size: 1.2rem; color: var(--primary-color);"></i>
                        }
                        <p-button 
                            label="Clear All"
                            icon="pi pi-times"
                            [text]="true"
                            size="small"
                            severity="secondary"
                            (onClick)="clearAreaPathFilter(project)"
                            [disabled]="!project.selectedAreaPaths || project.selectedAreaPaths.length === 0 || project.loadingAreaPathChange">
                        </p-button>
                    </div>
                </div>
                <div class="area-path-filters-enhanced">
                    @for (areaPath of project.areaPaths; track areaPath) {
                    <div class="filter-chip" 
                         [class.selected]="isAreaPathSelected(project, areaPath)"
                         (click)="toggleAreaPath(project, areaPath)">
                        <p-checkbox 
                            [binary]="true"
                            [ngModel]="isAreaPathSelected(project, areaPath)"
                            (ngModelChange)="toggleAreaPath(project, areaPath)"
                            [inputId]="'area-' + project.projectId + '-' + areaPath"
                            (click)="$event.stopPropagation()">
                        </p-checkbox>
                        <label [for]="'area-' + project.projectId + '-' + areaPath">
                            <span class="path-name">{{ areaPath }}</span>
                        </label>
                    </div>
                    }
                </div>
            </p-card>
            }

            <!-- Statistics Grid -->
            <div class="stats-grid">
                <!-- User Stories Stats -->
                <p-card styleClass="stats-card">
                    <h4><i class="pi pi-book"></i> User Stories</h4>
                    <div class="stat-row">
                        <span>Total:</span>
                        <strong>{{ project.userStoryStats.total }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>New:</span>
                        <strong>{{ project.userStoryStats.new }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>Active:</span>
                        <strong>{{ project.userStoryStats.active }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>Closed:</span>
                        <strong>{{ project.userStoryStats.closed }}</strong>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" 
                             [style.width.%]="getStatusPercentage(project.userStoryStats.closed, project.userStoryStats.total)">
                        </div>
                    </div>
                    <small>{{ getStatusPercentage(project.userStoryStats.closed, project.userStoryStats.total) }}% Complete</small>
                </p-card>

                <!-- Tasks Stats -->
                <p-card styleClass="stats-card">
                    <h4><i class="pi pi-check-square"></i> Tasks</h4>
                    <div class="stat-row">
                        <span>Total:</span>
                        <strong>{{ project.taskStats.total }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>New:</span>
                        <strong>{{ project.taskStats.new }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>Active:</span>
                        <strong>{{ project.taskStats.active }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>Closed:</span>
                        <strong>{{ project.taskStats.closed }}</strong>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" 
                             [style.width.%]="getStatusPercentage(project.taskStats.closed, project.taskStats.total)">
                        </div>
                    </div>
                    <small>{{ getStatusPercentage(project.taskStats.closed, project.taskStats.total) }}% Complete</small>
                </p-card>

                <!-- Bugs Stats -->
                <p-card styleClass="stats-card">
                    <h4><i class="pi pi-exclamation-triangle"></i> Bugs</h4>
                    <div class="stat-row">
                        <span>Total:</span>
                        <strong>{{ project.bugStats.total }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>New:</span>
                        <strong>{{ project.bugStats.new }}</strong>
                    </div>
                    <div class="stat-row">
                        <span>Active:</span>
                        <strong>{{ project.bugStats.active }}</strong>
                    </div>
                </p-card>

                <!-- Team Members Card -->
                <p-card styleClass="stats-card team-stats-card">
                    <h4><i class="pi pi-users"></i> Team Members</h4>
                    <div class="stat-row">
                        <span>Total:</span>
                        <strong>{{ project.teamMembers?.length || 0 }}</strong>
                    </div>
                    @if (project.teamMembers && project.teamMembers.length > 0) {
                    <div class="team-members-scrollable">
                        @for (member of project.teamMembers; track member.id) {
                        <div class="team-member-mini">
                            <div class="member-avatar-tiny">
                                {{ member.fullName.charAt(0) || '?' }}
                            </div>
                            <div class="member-info-tiny">
                                <span class="member-name-tiny">{{ member.fullName }}</span>
                                @if (member.allocationPercentage || member.AllocationPercentage) {
                                <span class="member-percentage">{{ member.allocationPercentage || member.AllocationPercentage }}%</span>
                                }
                            </div>
                        </div>
                        }
                    </div>
                    }
                </p-card>
            </div>

            <!-- Rework Chart Section (only shown when chart is loaded) -->
            @if (project.showReworkChart) {
            <div class="rework-chart-section mt-3">
                @if (project.loadingReworkChart) {
                <div style="text-align: center; padding: 2rem; background: var(--surface-card); border-radius: 8px; border: 1px solid var(--surface-border);">
                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <p style="margin-top: 1rem; color: var(--text-color-secondary);">Loading chart...</p>
                </div>
                }
                @if (!project.loadingReworkChart && project.reworkChartData) {
                <div class="rework-chart-content">
                    <div class="chart-header-inline">
                        <div>
                            <h4><i class="pi pi-chart-bar"></i> Coding vs Bug Fixing Hours</h4>
                            @if (project.chartCached !== undefined) {
                            <div class="chart-info">
                                <i [class]="project.chartCached ? 'pi pi-check-circle' : 'pi pi-database'"></i>
                                <span>{{ project.chartCached ? 'Cached data' : 'Fresh data' }} â€¢ {{ project.chartProcessingTime }}ms</span>
                            </div>
                            }
                        </div>
                        <p-button 
                            icon="pi pi-refresh" 
                            [text]="true" 
                            size="small"
                            [loading]="project.loadingReworkChart"
                            (onClick)="refreshReworkChart(project)"
                            pTooltip="Refresh chart data"
                            tooltipPosition="top">
                        </p-button>
                    </div>
                    <div class="chart-container" style="width: 100%; height: 350px; position: relative;">
                        <canvas [id]="'reworkChart-' + project.projectId"></canvas>
                    </div>
                    <div class="chart-footer">
                        <div class="chart-legend-info">
                            <div class="legend-item">
                                <span class="legend-color" style="background: rgba(34, 197, 94, 0.8);"></span>
                                <span>Coding Hours</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background: rgba(239, 68, 68, 0.8);"></span>
                                <span>Bug Fixing Hours</span>
                            </div>
                            <div class="legend-item">
                                <i class="pi pi-info-circle" style="color: var(--primary-color);"></i>
                                <span><strong>Rework %</strong> shown above bars</span>
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>
            }

            <!-- Project Comments -->
            <p-card styleClass="mt-3">
                <div class="comment-section">
                    <div class="comment-header">
                        <h4><i class="pi pi-comment"></i> Project Notes</h4>
                        @if (!project.isEditingComment) {
                        <p-button 
                            label="Edit"
                            icon="pi pi-pencil"
                            [text]="true"
                            size="small"
                            (onClick)="editComment(project)">
                        </p-button>
                        }
                    </div>
                    @if (!project.isEditingComment) {
                    <div class="comment-content">
                        @if (!project.comment) {
                        <p style="color: var(--text-color-secondary); font-style: italic;">
                            No notes yet. Click Edit to add notes.
                        </p>
                        }
                        @if (project.comment) {
                        <div class="preview-content" [innerHTML]="getSafeProjectComment(project.comment)"></div>
                        }
                    </div>
                    }
                    @if (project.isEditingComment) {
                    <div>
                        <p-editor 
                            [(ngModel)]="project.comment"
                            [style]="{'height':'150px', 'width': '100%', 'margin-bottom': '0.5rem'}"
                            placeholder="Enter project notes...">
                            <ng-template pTemplate="header">
                                <span class="ql-formats">
                                    <select class="ql-header">
                                        <option value="1">Heading 1</option>
                                        <option value="2">Heading 2</option>
                                        <option value="3">Heading 3</option>
                                        <option selected>Normal</option>
                                    </select>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-bold" type="button"></button>
                                    <button class="ql-italic" type="button"></button>
                                    <button class="ql-underline" type="button"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-list" value="ordered" type="button"></button>
                                    <button class="ql-list" value="bullet" type="button"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-link" type="button"></button>
                                    <button class="ql-code-block" type="button"></button>
                                </span>
                                <span class="ql-formats">
                                    <button class="ql-clean" type="button"></button>
                                </span>
                            </ng-template>
                        </p-editor>
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <p-button 
                                label="Cancel"
                                icon="pi pi-times"
                                [text]="true"
                                size="small"
                                severity="secondary"
                                (onClick)="cancelEditComment(project)">
                            </p-button>
                            <p-button 
                                label="Save"
                                icon="pi pi-check"
                                size="small"
                                (onClick)="saveComment(project)">
                            </p-button>
                        </div>
                    </div>
                    }
                </div>
            </p-card>
            </p-accordioncontent>
        </p-accordionpanel>
        }
    </p-accordion>
    }

    <!-- Empty State -->
    @if (!loading && projectStatuses.length === 0) {
    <p-card>
        <div style="text-align: center; padding: 3rem 1rem;">
            <i class="pi pi-info-circle" style="font-size: 3rem; color: var(--text-color-secondary);"></i>
            <h3 style="margin: 1rem 0;">No Active Projects</h3>
            <p style="color: var(--text-color-secondary);">
                There are no active projects to display status for.
            </p>
        </div>
    </p-card>
    }

    <!-- Tasks Modal -->
    <p-dialog 
        [(visible)]="showTasksModal"
        [header]="'Tasks - ' + modalProjectName"
        [modal]="true"
        [style]="{width: '900px'}"
        [maximizable]="true">
        <p-table 
            [value]="modalTasks"
            [paginator]="true"
            [rows]="10"
            styleClass="p-datatable-sm"
            responsiveLayout="scroll"
            [sortMode]="'multiple'">
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="id" style="width: 80px;">
                        ID
                        <p-sortIcon field="id"></p-sortIcon>
                    </th>
                    <th pSortableColumn="title">
                        Title
                        <p-sortIcon field="title"></p-sortIcon>
                    </th>
                    <th pSortableColumn="state" style="width: 100px;">
                        State
                        <p-sortIcon field="state"></p-sortIcon>
                    </th>
                    <th pSortableColumn="assignedTo" style="width: 150px;">
                        Assigned To
                        <p-sortIcon field="assignedTo"></p-sortIcon>
                    </th>
                    <th pSortableColumn="subActivity" style="width: 150px;">
                        Sub Activity
                        <p-sortIcon field="subActivity"></p-sortIcon>
                    </th>
                    <th pSortableColumn="completedWork" style="width: 100px;">
                        Hours
                        <p-sortIcon field="completedWork"></p-sortIcon>
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-task>
                <tr>
                    <td>{{ task.id }}</td>
                    <td>{{ task.title }}</td>
                    <td>
                        <p-tag 
                            [value]="task.state"
                            [attr.severity]="getTaskStateSeverity(task.state)">
                        </p-tag>
                    </td>
                    <td>{{ task.assignedTo }}</td>
                    <td>{{ task.subActivity || '-' }}</td>
                    <td>{{ task.completedWork || 0 }}h</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem;">
                        No tasks available
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-dialog>

</div>

