<div class="user-stories-container">
    <p-toast></p-toast>

    <!-- Header -->
    <div class="header-section">
        <div>
            <h1 class="page-title">
                <i class="pi pi-book"></i> User Stories
            </h1>
            <p class="page-subtitle">View and manage user stories from Azure DevOps</p>
        </div>
    </div>

    <!-- Project Selection and Filters -->
    <p-card>
        <div class="filter-controls">
            <div class="form-field">
                <label for="project">Select Project *</label>
                <p-select 
                    inputId="project"
                    [options]="projects"
                    [(ngModel)]="selectedProjectId"
                    (ngModelChange)="onProjectChange()"
                    placeholder="Select a project"
                    optionLabel="projectName"
                    optionValue="projectId"
                    [style]="{'width':'100%'}">
                </p-select>
            </div>

            <span class="p-input-icon-left" style="flex: 1;">
               
                <input 
                    pInputText 
                    type="text" 
                    [(ngModel)]="searchQuery"
                    (ngModelChange)="onSearchChange()"
                    placeholder="Search stories..."
                    style="width: 100%;" />
            </span>

            <p-select 
                [options]="statusOptions"
                [(ngModel)]="filterStatus"
                (ngModelChange)="onFilterChange()"
                [style]="{'width':'180px'}">
            </p-select>

            <p-select 
                [options]="priorityOptions"
                [(ngModel)]="filterPriority"
                (ngModelChange)="onFilterChange()"
                [style]="{'width':'180px'}">
            </p-select>
        </div>
    </p-card>

    <!-- Stats Cards -->
    @if (selectedProjectId && !loading) {
    <div class="stats-grid">
        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon primary">
                    <i class="pi pi-list"></i>
                </div>
                <div>
                    <div class="stat-value">{{ filteredUserStories.length }}</div>
                    <div class="stat-label">Total Stories</div>
                </div>
            </div>
        </p-card>
        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon success">
                    <i class="pi pi-chart-line"></i>
                </div>
                <div>
                    <div class="stat-value">{{ getTotalStoryPoints() }}</div>
                    <div class="stat-label">Story Points</div>
                </div>
            </div>
        </p-card>
        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon info">
                    <i class="pi pi-check-circle"></i>
                </div>
                <div>
                    <div class="stat-value">{{ getStoriesCountByStatus('closed') }}</div>
                    <div class="stat-label">Closed</div>
                </div>
            </div>
        </p-card>
        <p-card styleClass="stat-card">
            <div class="stat-content">
                <div class="stat-icon warning">
                    <i class="pi pi-exclamation-circle"></i>
                </div>
                <div>
                    <div class="stat-value">{{ getStoriesCountByStatus('active') }}</div>
                    <div class="stat-label">Active</div>
                </div>
            </div>
        </p-card>
    </div>
    }

    <!-- User Stories Table -->
    @if (selectedProjectId) {
    <p-card styleClass="mt-4">
        <p-table 
            [value]="filteredUserStories" 
            [loading]="loading"
            styleClass="p-datatable-sm"
            responsiveLayout="scroll"
            [sortMode]="'multiple'">
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="devOpsWorkItemId" style="width: 80px;">
                        ID
                        <p-sortIcon field="devOpsWorkItemId"></p-sortIcon>
                    </th>
                    <th pSortableColumn="title">
                        Title
                        <p-sortIcon field="title"></p-sortIcon>
                    </th>
                    <th pSortableColumn="status" style="width: 120px;">
                        Status
                        <p-sortIcon field="status"></p-sortIcon>
                    </th>
                    <th pSortableColumn="priority" style="width: 120px;">
                        Priority
                        <p-sortIcon field="priority"></p-sortIcon>
                    </th>
                    <th pSortableColumn="storyPoints" style="width: 100px;">
                        Points
                        <p-sortIcon field="storyPoints"></p-sortIcon>
                    </th>
                    <th pSortableColumn="assignedTo" style="width: 180px;">
                        Assigned To
                        <p-sortIcon field="assignedTo"></p-sortIcon>
                    </th>
                    <th style="width: 120px;">Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-story>
                <tr>
                    <td>{{ story.devOpsWorkItemId }}</td>
                    <td><strong>{{ story.title }}</strong></td>
                    <td>
                        <p-tag 
                            [value]="story.status"
                            [attr.severity]="getStatusSeverity(story.status)">
                        </p-tag>
                    </td>
                    <td>
                        <p-tag 
                            [value]="getPriorityLabel(story.priority)"
                            [attr.severity]="getPrioritySeverity(story.priority)">
                        </p-tag>
                    </td>
                    <td>{{ story.storyPoints || '-' }}</td>
                    <td>{{ story.assignedTo || 'Unassigned' }}</td>
                    <td>
                        <p-button 
                            icon="pi pi-eye"
                            (onClick)="viewDetails(story)"
                            [text]="true"
                            [rounded]="true"
                            severity="info"
                            size="small"
                            [attr.pTooltip]="'View Details'">
                        </p-button>
                        <p-button 
                            icon="pi pi-external-link"
                            (onClick)="openDevOpsLink(story.devOpsUrl)"
                            [text]="true"
                            [rounded]="true"
                            severity="secondary"
                            size="small"
                            [attr.pTooltip]="'Open in DevOps'">
                        </p-button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 3rem;">
                        <i class="pi pi-info-circle" style="font-size: 3rem; color: var(--text-color-secondary);"></i>
                        <h3>{{ selectedProjectId ? 'No User Stories Found' : 'Select a Project' }}</h3>
                        <p style="color: var(--text-color-secondary);">
                            @if (!selectedProjectId) {
                            <span>Please select a project to view user stories</span>
                            }
                            @if (selectedProjectId && searchQuery) {
                            <span>Try adjusting your search criteria</span>
                            }
                            @if (selectedProjectId && !searchQuery) {
                            <span>No user stories found for this project</span>
                            }
                        </p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>
    }

    <!-- Detail Modal -->
    <p-dialog 
        [(visible)]="showDetailModal"
        header="User Story Details"
        [modal]="true"
        [style]="{width: '700px'}"
        [maximizable]="true">
        @if (selectedUserStory) {
        <div class="detail-content">
            <div class="detail-header">
                <h2>{{ selectedUserStory.title }}</h2>
                <div class="detail-tags">
                    <p-tag 
                        [value]="selectedUserStory.status"
                        [attr.severity]="getStatusSeverity(selectedUserStory.status)">
                    </p-tag>
                    <p-tag 
                        [value]="getPriorityLabel(selectedUserStory.priority)"
                        [attr.severity]="getPrioritySeverity(selectedUserStory.priority)">
                    </p-tag>
                </div>
            </div>

            @if (selectedUserStory.description) {
            <div class="detail-section">
                <h4><i class="pi pi-align-left"></i> Description</h4>
                <p>{{ selectedUserStory.description }}</p>
            </div>
            }

            @if (selectedUserStory.acceptanceCriteria) {
            <div class="detail-section">
                <h4><i class="pi pi-check-square"></i> Acceptance Criteria</h4>
                <p>{{ selectedUserStory.acceptanceCriteria }}</p>
            </div>
            }

            <div class="detail-grid">
                <div class="detail-section">
                    <h4><i class="pi pi-user"></i> Assigned To</h4>
                    <p>{{ selectedUserStory.assignedTo || 'Unassigned' }}</p>
                </div>

                <div class="detail-section">
                    <h4><i class="pi pi-chart-line"></i> Story Points</h4>
                    <p>{{ selectedUserStory.storyPoints || 'Not set' }}</p>
                </div>
            </div>

            @if (selectedUserStory.areaPath) {
            <div class="detail-section">
                <h4><i class="pi pi-folder"></i> Area Path</h4>
                <p>{{ selectedUserStory.areaPath }}</p>
            </div>
            }

            @if (selectedUserStory.iterationPath) {
            <div class="detail-section">
                <h4><i class="pi pi-calendar"></i> Iteration Path</h4>
                <p>{{ selectedUserStory.iterationPath }}</p>
            </div>
            }
        </div>
        }

        <ng-template pTemplate="footer">
            <p-button 
                label="Close"
                (onClick)="closeModal()"
                [text]="true"
                severity="secondary">
            </p-button>
            <p-button 
                label="Open in DevOps"
                icon="pi pi-external-link"
                (onClick)="openDevOpsLink(selectedUserStory?.devOpsUrl)">
            </p-button>
        </ng-template>
    </p-dialog>
</div>

